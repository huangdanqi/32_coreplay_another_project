#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Enhanced test script to show complete diary entries and related events.
This script displays the full diary entry structure and content generated by the interactive agent.
"""

import sys
import os
import json
import asyncio
import logging
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any

# Add the project root to the path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('detailed_diary_test.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class MockMQTTEvent:
    """Mock MQTT event for testing."""
    
    def __init__(self, event_type: str = "same_frequency_event", user_id: int = 1):
        self.event_type = event_type
        self.user_id = user_id
        self.timestamp = datetime.now()
        self.payload = {
            "event_type": event_type,
            "user_id": user_id,
            "interaction_type": "æ‘¸æ‘¸è„¸",
            "same_frequency_event": "ä¸€èµ·ç©è€",
            "toy_owner_nickname": "å°æ˜",
            "close_friend_nickname": "å°çº¢",
            "close_friend_owner_nickname": "å°çº¢çš„å¦ˆå¦ˆ"
        }

async def test_detailed_diary_generation():
    """Test detailed diary generation with full content display."""
    print("=== Detailed Diary Entry Generation Test ===")
    print("=" * 60)
    
    try:
        # Import the interactive agent components
        from diary_agent.agents.interactive_agent import InteractiveAgent
        from diary_agent.core.llm_manager import LLMConfigManager
        from diary_agent.utils.data_models import EventData, PromptConfig
        from diary_agent.integration.interaction_data_reader import InteractionDataReader
        
        print("âœ… Successfully imported interactive agent components")
        
        # Initialize LLM config manager
        llm_manager = LLMConfigManager()
        
        print(f"ğŸ”§ Using Ollama configuration: {llm_manager.get_default_provider()}")
        
        # Get the default provider config
        default_provider_name = llm_manager.get_default_provider()
        default_provider_config = llm_manager.get_provider_config(default_provider_name)
        
        print(f"   Model: {default_provider_config.model_name}")
        print(f"   Endpoint: {default_provider_config.api_endpoint}")
        
        # Initialize prompt configuration with better prompts
        prompt_config = PromptConfig(
            agent_type="interactive",
            system_prompt="""ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½ç©å…·çš„æ—¥è®°ç”ŸæˆåŠ©æ‰‹ã€‚ä½ éœ€è¦æ ¹æ®äººæœºäº’åŠ¨äº‹ä»¶ç”Ÿæˆæœ‰è¶£ã€ç”ŸåŠ¨çš„æ—¥è®°å†…å®¹ã€‚

è¦æ±‚ï¼š
1. æ ‡é¢˜ï¼šæœ€å¤š6ä¸ªå­—ç¬¦ï¼Œè¦ç®€æ´æœ‰è¶£
2. å†…å®¹ï¼šæœ€å¤š35ä¸ªå­—ç¬¦ï¼Œè¦åŒ…å«äº‹ä»¶ä¿¡æ¯å’Œæƒ…æ„Ÿè¡¨è¾¾
3. æƒ…æ„Ÿæ ‡ç­¾ï¼šä»é¢„å®šä¹‰çš„æƒ…æ„Ÿä¸­é€‰æ‹©åˆé€‚çš„
4. å¿…é¡»åŒ…å«ï¼šäº‹ä»¶åç§°ã€ç©å…·ä¸»äººæ˜µç§°ã€å¥½æœ‹å‹æ˜µç§°ã€å¥½æœ‹å‹ä¸»äººæ˜µç§°

è¯·ç”¨ä¸­æ–‡ç”Ÿæˆå†…å®¹ï¼Œè¦è‡ªç„¶ã€æœ‰è¶£ã€ç¬¦åˆç©å…·çš„æ€§æ ¼ã€‚""",
            user_prompt_template="""è¯·æ ¹æ®ä»¥ä¸‹äººæœºäº’åŠ¨äº‹ä»¶ç”Ÿæˆæ—¥è®°å†…å®¹ï¼š

äº‹ä»¶æ•°æ®ï¼š{event_data}

è¯·ç”Ÿæˆï¼š
1. æ ‡é¢˜ï¼ˆæœ€å¤š6å­—ç¬¦ï¼‰
2. å†…å®¹ï¼ˆæœ€å¤š35å­—ç¬¦ï¼‰
3. æƒ…æ„Ÿæ ‡ç­¾ï¼ˆä»ï¼šç”Ÿæ°”æ„¤æ€’ã€æ‚²ä¼¤éš¾è¿‡ã€æ‹…å¿§ã€ç„¦è™‘å¿§æ„ã€æƒŠè®¶éœ‡æƒŠã€å¥½å¥‡ã€ç¾æ„§ã€å¹³é™ã€å¼€å¿ƒå¿«ä¹ã€å…´å¥‹æ¿€åŠ¨ä¸­é€‰æ‹©ï¼‰

æ ¼å¼è¦æ±‚ï¼š
- æ ‡é¢˜è¦ç®€æ´æœ‰è¶£
- å†…å®¹è¦åŒ…å«äº‹ä»¶ä¿¡æ¯å’Œæƒ…æ„Ÿ
- æƒ…æ„Ÿè¦ç¬¦åˆäº‹ä»¶æ€§è´¨""",
            output_format={
                "content": "string",
                "emotion_tags": "list",
                "title": "string"
            },
            validation_rules={
                "max_content_length": 35,
                "max_title_length": 6,
                "required_fields": ["content", "title", "emotion_tags"]
            }
        )
        
        # Initialize interaction data reader
        data_reader = InteractionDataReader()
        
        # Initialize interactive agent
        interactive_agent = InteractiveAgent(
            agent_type="interactive",
            prompt_config=prompt_config,
            llm_manager=llm_manager,
            data_reader=data_reader
        )
        
        print("âœ… Interactive agent initialized successfully")
        
        # Test scenarios with detailed event information
        scenarios = [
            {
                "name": "åŒé¢‘ç©è€äº‹ä»¶",
                "event_name": "liked_interaction_once",
                "interaction_type": "ä¸€èµ·ç©è€",
                "same_frequency_event": "ä¸€èµ·ç©è€",
                "description": "å°æ˜å’Œå°çº¢åŒæ—¶è§¦å‘äº†ä¸€èµ·ç©è€çš„äº’åŠ¨"
            },
            {
                "name": "æ‘¸æ‘¸å¤´äº‹ä»¶",
                "event_name": "liked_interaction_3_to_5_times",
                "interaction_type": "æ‘¸æ‘¸å¤´",
                "same_frequency_event": "æ‘¸æ‘¸å¤´",
                "description": "å°æ˜å’Œå°çº¢åŒæ—¶è¢«æ‘¸äº†å¤´"
            },
            {
                "name": "å–‚é£Ÿäº‹ä»¶",
                "event_name": "liked_interaction_over_5_times",
                "interaction_type": "å–‚é£Ÿ",
                "same_frequency_event": "å–‚é£Ÿ",
                "description": "å°æ˜å’Œå°çº¢åŒæ—¶è¢«å–‚é£Ÿ"
            }
        ]
        
        all_results = []
        
        for i, scenario in enumerate(scenarios, 1):
            print(f"\n{'='*20} æµ‹è¯•åœºæ™¯ {i}: {scenario['name']} {'='*20}")
            
            # Create mock MQTT event
            mqtt_event = MockMQTTEvent(
                event_type="same_frequency_event",
                user_id=1
            )
            mqtt_event.payload["interaction_type"] = scenario['interaction_type']
            mqtt_event.payload["same_frequency_event"] = scenario['same_frequency_event']
            
            print(f"ğŸ“¡ MQTTäº‹ä»¶æ•°æ®:")
            print(f"   äº‹ä»¶ç±»å‹: {mqtt_event.event_type}")
            print(f"   ç”¨æˆ·ID: {mqtt_event.user_id}")
            print(f"   äº’åŠ¨ç±»å‹: {mqtt_event.payload['interaction_type']}")
            print(f"   åŒé¢‘äº‹ä»¶: {mqtt_event.payload['same_frequency_event']}")
            print(f"   ç©å…·ä¸»äºº: {mqtt_event.payload['toy_owner_nickname']}")
            print(f"   å¥½æœ‹å‹: {mqtt_event.payload['close_friend_nickname']}")
            print(f"   å¥½æœ‹å‹ä¸»äºº: {mqtt_event.payload['close_friend_owner_nickname']}")
            print(f"   æè¿°: {scenario['description']}")
            
            # Create event data for the agent
            event_data = EventData(
                event_id=f"test_event_{datetime.now().timestamp()}",
                event_type="human_machine_interaction",
                event_name=scenario['event_name'],
                timestamp=mqtt_event.timestamp,
                user_id=mqtt_event.user_id,
                context_data=mqtt_event.payload,
                metadata={
                    "trigger_condition": "MQTT message received with event type",
                    "content_requirements": [
                        "Same frequency event name",
                        "Toy owner's nickname",
                        "Close friend's nickname",
                        "Close friend's owner's nickname"
                    ],
                    "scenario_description": scenario['description']
                }
            )
            
            print(f"\nğŸ”„ æ­£åœ¨å¤„ç†äº‹ä»¶: {scenario['event_name']}")
            
            # Process the event with the interactive agent
            result = await interactive_agent.process_event(event_data)
            
            print(f"âœ… äº‹ä»¶å¤„ç†å®Œæˆ")
            
            # Display the complete diary entry
            print(f"\nğŸ“ ç”Ÿæˆçš„æ—¥è®°æ¡ç›®:")
            print(f"   æ¡ç›®ID: {result.entry_id}")
            print(f"   ç”¨æˆ·ID: {result.user_id}")
            print(f"   æ—¶é—´æˆ³: {result.timestamp}")
            print(f"   äº‹ä»¶ç±»å‹: {result.event_type}")
            print(f"   äº‹ä»¶åç§°: {result.event_name}")
            print(f"   æ ‡é¢˜: '{result.title}' (é•¿åº¦: {len(result.title)})")
            print(f"   å†…å®¹: '{result.content}' (é•¿åº¦: {len(result.content)})")
            print(f"   æƒ…æ„Ÿæ ‡ç­¾: {[tag.value for tag in result.emotion_tags]}")
            print(f"   ä»£ç†ç±»å‹: {result.agent_type}")
            print(f"   LLMæä¾›å•†: {result.llm_provider}")
            
            # Validate content requirements
            print(f"\nğŸ” å†…å®¹éªŒè¯:")
            required_fields = [
                "same_frequency_event",
                "toy_owner_nickname", 
                "close_friend_nickname",
                "close_friend_owner_nickname"
            ]
            
            content_text = f"{result.title} {result.content}"
            validation_results = {}
            
            for field in required_fields:
                field_chinese = {
                    "same_frequency_event": "ä¸€èµ·ç©è€",
                    "toy_owner_nickname": "å°æ˜",
                    "close_friend_nickname": "å°çº¢",
                    "close_friend_owner_nickname": "å°çº¢çš„å¦ˆå¦ˆ"
                }
                
                if field_chinese[field] in content_text:
                    validation_results[field] = f"âœ… æ‰¾åˆ°: {field_chinese[field]}"
                else:
                    validation_results[field] = f"âŒ ç¼ºå¤±: {field_chinese[field]}"
            
            for field, status in validation_results.items():
                print(f"   {field}: {status}")
            
            # Save detailed result
            scenario_result = {
                "scenario_name": scenario['name'],
                "event_name": scenario['event_name'],
                "interaction_type": scenario['interaction_type'],
                "same_frequency_event": scenario['same_frequency_event'],
                "description": scenario['description'],
                "mqtt_event": mqtt_event.payload,
                "diary_entry": {
                    "entry_id": result.entry_id,
                    "user_id": result.user_id,
                    "timestamp": result.timestamp.isoformat(),
                    "event_type": result.event_type,
                    "event_name": result.event_name,
                    "title": result.title,
                    "content": result.content,
                    "emotion_tags": [tag.value for tag in result.emotion_tags],
                    "agent_type": result.agent_type,
                    "llm_provider": result.llm_provider
                },
                "validation_results": validation_results
            }
            
            all_results.append(scenario_result)
            
            print(f"\nâœ… åœºæ™¯ {i} å®Œæˆ")
            print(f"{'='*60}")
        
        # Save all detailed results
        with open('detailed_diary_results.json', 'w', encoding='utf-8') as f:
            json.dump(all_results, f, indent=2, ensure_ascii=False)
        
        print(f"\nğŸ’¾ è¯¦ç»†ç»“æœå·²ä¿å­˜åˆ°: detailed_diary_results.json")
        
        # Summary
        print(f"\nğŸ“Š æµ‹è¯•æ€»ç»“:")
        print(f"   æµ‹è¯•åœºæ™¯æ•°: {len(scenarios)}")
        print(f"   æˆåŠŸå¤„ç†: {len(all_results)}")
        print(f"   LLMæ¨¡å‹: {default_provider_config.model_name}")
        print(f"   æä¾›å•†: {default_provider_name}")
        
        # Show sample diary entries
        print(f"\nğŸ“– ç”Ÿæˆçš„æ—¥è®°æ¡ç›®ç¤ºä¾‹:")
        for i, result in enumerate(all_results, 1):
            diary = result['diary_entry']
            print(f"\n   åœºæ™¯ {i}: {result['scenario_name']}")
            print(f"   æ ‡é¢˜: {diary['title']}")
            print(f"   å†…å®¹: {diary['content']}")
            print(f"   æƒ…æ„Ÿ: {', '.join(diary['emotion_tags'])}")
        
        print(f"\nğŸ‰ è¯¦ç»†æ—¥è®°ç”Ÿæˆæµ‹è¯•å®Œæˆ!")
        
    except Exception as e:
        print(f"âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        logger.error(f"è¯¦ç»†æµ‹è¯•å¤±è´¥: {e}", exc_info=True)

def main():
    """Main test function."""
    print("ğŸš€ å¯åŠ¨è¯¦ç»†æ—¥è®°æ¡ç›®ç”Ÿæˆæµ‹è¯•")
    print("=" * 60)
    
    # Check if Ollama is running
    print("ğŸ” æ£€æŸ¥Ollamaå¯ç”¨æ€§...")
    try:
        import requests
        response = requests.get("http://localhost:11434/api/tags", timeout=5)
        if response.status_code == 200:
            print("âœ… Ollamaæ­£åœ¨è¿è¡Œä¸”å¯è®¿é—®")
        else:
            print("âš ï¸  Ollamaå“åº”ä½†çŠ¶æ€å¼‚å¸¸")
    except Exception as e:
        print(f"âŒ Ollamaæ— æ³•è®¿é—®: {e}")
        print("è¯·ç¡®ä¿Ollamaåœ¨ http://localhost:11434 ä¸Šè¿è¡Œ")
        return
    
    # Run the detailed test
    asyncio.run(test_detailed_diary_generation())
    
    print("\nğŸ¯ æ‰€æœ‰æµ‹è¯•å®Œæˆ!")
    print("æŸ¥çœ‹ detailed_diary_results.json è·å–è¯¦ç»†ç»“æœ")

if __name__ == "__main__":
    main()

